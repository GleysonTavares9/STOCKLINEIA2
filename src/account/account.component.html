<div class="max-w-4xl mx-auto px-4 pt-8 md:px-8 text-white">
  <div class="flex items-center gap-4 mb-8">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-teal-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V7a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
    </svg>
    <h1 class="text-3xl font-bold tracking-tight">Gerenciamento de Conta</h1>
  </div>

  @if (currentUser(); as user) {
    <!-- Tabs Navigation -->
    <div class="border-b border-zinc-700 mb-8">
      <nav class="-mb-px flex space-x-8" aria-label="Tabs">
        <button 
          (click)="activeTab.set('overview')" 
          class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors"
          [class.border-teal-500]="activeTab() === 'overview'"
          [class.text-teal-400]="activeTab() === 'overview'"
          [class.border-transparent]="activeTab() !== 'overview'"
          [class.text-zinc-400]="activeTab() !== 'overview'"
          [class.hover:text-zinc-200]="activeTab() !== 'overview'"
          [class.hover:border-zinc-500]="activeTab() !== 'overview'">
          Visão Geral
        </button>

        <button 
          (click)="activeTab.set('history')" 
          class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors"
          [class.border-teal-500]="activeTab() === 'history'"
          [class.text-teal-400]="activeTab() === 'history'"
          [class.border-transparent]="activeTab() !== 'history'"
          [class.text-zinc-400]="activeTab() !== 'history'"
          [class.hover:text-zinc-200]="activeTab() !== 'history'"
          [class.hover:border-zinc-500]="activeTab() !== 'history'">
          Histórico
        </button>

        <button 
          (click)="activeTab.set('notifications')" 
          class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors flex items-center gap-2"
          [class.border-teal-500]="activeTab() === 'notifications'"
          [class.text-teal-400]="activeTab() === 'notifications'"
          [class.border-transparent]="activeTab() !== 'notifications'"
          [class.text-zinc-400]="activeTab() !== 'notifications'"
          [class.hover:text-zinc-200]="activeTab() !== 'notifications'"
          [class.hover:border-zinc-500]="activeTab() !== 'notifications'">
          Notificações
          @if (unreadNotificationsCount() > 0) {
            <span class="bg-teal-600 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">
              {{ unreadNotificationsCount() }}
            </span>
          }
        </button>
      </nav>
    </div>

    <!-- Tab Content -->
    @switch (activeTab()) {
      @case ('overview') {
        <div class="space-y-8">
          <div class="bg-[#1A181A] rounded-2xl border border-zinc-800 divide-y divide-zinc-800">
            <div class="p-6">
              <h3 class="text-lg font-semibold text-zinc-300">Resumo da Conta</h3>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-px">
              <div class="p-6 bg-zinc-900/50">
                <p class="text-sm font-medium text-zinc-400">Endereço de E-mail</p>
                <p class="text-lg text-white truncate">{{ user.email }}</p>
              </div>
              <div class="p-6 bg-zinc-900/50">
                <p class="text-sm font-medium text-zinc-400">Data de Criação</p>
                <p class="text-lg text-white">{{ accountCreationDate() }}</p>
              </div>
            </div>
          </div>

          <div class="bg-[#1A181A] rounded-2xl border border-zinc-800 divide-y divide-zinc-800">
            <div class="p-6 flex justify-between items-center">
              <h3 class="text-lg font-semibold text-zinc-300">Uso de Créditos</h3>
              <a routerLink="/subscribe" class="text-sm font-semibold text-teal-400 hover:text-teal-300 transition-colors">Comprar mais</a>
            </div>
            @if(currentUserProfile(); as profile) {
              <div class="grid grid-cols-1 md:grid-cols-2 gap-px">
                <div class="p-6 bg-zinc-900/50">
                  <p class="text-sm font-medium text-zinc-400">Créditos Restantes</p>
                  <p class="text-4xl font-bold text-teal-400">{{ profile.credits }}</p>
                </div>
                <div class="p-6 bg-zinc-900/50">
                  <p class="text-sm font-medium text-zinc-400">Total de Músicas Criadas</p>
                  <p class="text-4xl font-bold text-white">{{ userMusic().length }}</p>
                </div>
              </div>
            } @else {
              <div class="p-6 text-center text-zinc-500">
                Carregando informações de créditos...
              </div>
            }
          </div>

          <div class="bg-[#1A181A] rounded-2xl border border-zinc-800">
            <div class="p-6">
              <h3 class="text-lg font-semibold text-zinc-300">Plano e Faturamento</h3>
            </div>
            <div class="p-6 border-t border-zinc-800">
              @if (hasActiveSubscription()) {
                <p class="text-zinc-400 mb-4">
                  Gerencie sua assinatura, visualize o histórico de faturamento, compre mais créditos e atualize sua forma de pagamento através do nosso portal seguro.
                </p>
                <button 
                  (click)="manageSubscription()" 
                  [disabled]="isManaging()"
                  class="inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-teal-600 hover:bg-teal-700 disabled:opacity-50 disabled:cursor-wait">
                  @if (isManaging()) {
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Redirecionando...
                  } @else {
                    Gerenciar Assinatura e Faturamento
                  }
                </button>
                @if (managementError()) {
                  <p class="text-red-400 text-sm mt-4">{{ managementError() }}</p>
                }
              } @else {
                <p class="text-zinc-400 mb-4">
                  Você não possui uma assinatura ativa. Compre um plano para desbloquear mais recursos e créditos.
                </p>
                <a routerLink="/subscribe" class="inline-block bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                  Ver Planos
                </a>
              }
            </div>
          </div>
        </div>
      }
      @case ('history') {
        <div class="bg-[#1A181A] rounded-2xl border border-zinc-800">
          <div class="p-6">
            <h3 class="text-lg font-semibold text-zinc-300">Histórico de Transações</h3>
          </div>
          <div class="border-t border-zinc-800">
            @if (isLoadingTransactions()) {
              <div class="p-8 text-center text-zinc-500">Carregando histórico...</div>
            } @else {
              @if (transactions().length === 0) {
                <div class="p-8 text-center text-zinc-500">Nenhuma transação encontrada.</div>
              } @else {
                <ul class="divide-y divide-zinc-800">
                  @for (tx of transactions(); track tx.id) {
                    <li class="p-6 flex items-center justify-between">
                      <div class="flex items-center gap-4">
                        @if (tx.amount > 0) {
                          <div class="w-10 h-10 flex-shrink-0 rounded-full bg-green-900/50 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                            </svg>
                          </div>
                        } @else {
                           <div class="w-10 h-10 flex-shrink-0 rounded-full bg-red-900/50 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M20 12H4" />
                            </svg>
                          </div>
                        }
                        <div>
                          <p class="font-medium text-white">{{ tx.description }}</p>
                          <p class="text-sm text-zinc-400">{{ tx.created_at | date:'dd/MM/yyyy HH:mm' }}</p>
                        </div>
                      </div>
                      <p class="font-semibold text-lg" [class.text-green-400]="tx.amount > 0" [class.text-red-400]="tx.amount < 0">
                        {{ tx.amount > 0 ? '+' : '' }}{{ tx.amount }} Créditos
                      </p>
                    </li>
                  }
                </ul>
              }
            }
          </div>
        </div>
      }
      @case ('notifications') {
        <div class="bg-[#1A181A] rounded-2xl border border-zinc-800">
          <div class="p-6">
            <h3 class="text-lg font-semibold text-zinc-300">Notificações</h3>
          </div>
          <div class="border-t border-zinc-800">
             @if (isLoadingNotifications()) {
              <div class="p-8 text-center text-zinc-500">Carregando notificações...</div>
            } @else {
              @if (notifications().length === 0) {
                <div class="p-8 text-center text-zinc-500">Você não tem nenhuma notificação.</div>
              } @else {
                 <ul class="divide-y divide-zinc-800">
                  @for (notification of notifications(); track notification.id) {
                    <li 
                      class="p-6 flex items-start gap-4 transition-colors"
                      [class.cursor-pointer]="!notification.read"
                      [class.hover:bg-zinc-800/50]="!notification.read"
                      (click)="markAsRead(notification)">
                      <div class="flex-shrink-0 mt-1">
                        @if (!notification.read) {
                          <span class="block h-2.5 w-2.5 rounded-full bg-teal-500"></span>
                        } @else {
                          <span class="block h-2.5 w-2.5 rounded-full bg-zinc-700"></span>
                        }
                      </div>
                      <div class="flex-grow">
                        <div class="flex justify-between items-baseline">
                          <p class="font-semibold text-white">{{ notification.title }}</p>
                          <p class="text-xs text-zinc-500">{{ notification.created_at | date:'dd/MM/yy' }}</p>
                        </div>
                        <p class="mt-1 text-sm text-zinc-400">{{ notification.message }}</p>
                      </div>
                    </li>
                  }
                </ul>
              }
            }
          </div>
        </div>
      }
    }

  } @else {
    <div class="p-8 text-center text-zinc-500">
      <p>Você precisa estar logado para ver esta página.</p>
    </div>
  }
</div>